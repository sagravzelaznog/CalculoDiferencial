name: Verificaci√≥n del Curso de C√°lculo Diferencial

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  verify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Verificar dependencias
      run: |
        python check_dependencies.py
        
    - name: Verificar estructura de archivos
      run: |
        echo "Verificando archivos principales..."
        test -f index.html
        test -f firebase-config.js
        test -f auth-manager.js
        test -f server.py
        test -f check_dependencies.py
        test -f package.json
        test -f README.md
        test -f LICENSE
        test -f CONTRIBUTING.md
        test -f CHANGELOG.md
        test -f SECURITY.md
        test -f CONTRIBUTORS.md
        echo "‚úÖ Todos los archivos principales est√°n presentes"
        
    - name: Verificar m√≥dulos
      run: |
        echo "Verificando m√≥dulos del curso..."
        test -f modulo1_relaciones_funciones.html
        test -f modulo2_limites.html
        test -f modulo3_continuidad.html
        test -f modulo4_la_derivada.html
        test -f modulo5_aplicaciones_derivada.html
        echo "‚úÖ Todos los m√≥dulos est√°n presentes"
        
    - name: Verificar archivos de GitHub
      run: |
        echo "Verificando archivos de GitHub..."
        test -d .github
        test -f .github/ISSUE_TEMPLATE/bug_report.md
        test -f .github/ISSUE_TEMPLATE/feature_request.md
        test -f .github/ISSUE_TEMPLATE/content_improvement.md
        test -f .github/pull_request_template.md
        echo "‚úÖ Todos los archivos de GitHub est√°n presentes"
        
    - name: Verificar configuraci√≥n
      run: |
        echo "Verificando archivos de configuraci√≥n..."
        test -f .gitignore
        test -f .gitattributes
        test -f config.env
        echo "‚úÖ Todos los archivos de configuraci√≥n est√°n presentes"
        
    - name: Verificar derechos de autor
      run: |
        echo "Verificando derechos de autor en archivos HTML..."
        grep -r "JMGV-PTEL-2025" *.html || (echo "‚ùå Derechos de autor no encontrados en archivos HTML" && exit 1)
        echo "‚úÖ Derechos de autor verificados"
        
    - name: Verificar sintaxis HTML
      run: |
        echo "Verificando sintaxis HTML b√°sica..."
        for file in *.html; do
          echo "Verificando $file..."
          grep -q "<!DOCTYPE html>" "$file" || (echo "‚ùå DOCTYPE no encontrado en $file" && exit 1)
          grep -q "<html" "$file" || (echo "‚ùå Etiqueta html no encontrada en $file" && exit 1)
          grep -q "</html>" "$file" || (echo "‚ùå Etiqueta de cierre html no encontrada en $file" && exit 1)
        done
        echo "‚úÖ Sintaxis HTML b√°sica verificada"
        
    - name: Verificar sintaxis JavaScript
      run: |
        echo "Verificando sintaxis JavaScript b√°sica..."
        for file in *.js; do
          echo "Verificando $file..."
          node -c "$file" || (echo "‚ùå Error de sintaxis en $file" && exit 1)
        done
        echo "‚úÖ Sintaxis JavaScript verificada"
        
    - name: Verificar sintaxis Python
      run: |
        echo "Verificando sintaxis Python..."
        python -m py_compile server.py
        python -m py_compile check_dependencies.py
        echo "‚úÖ Sintaxis Python verificada"
        
    - name: Verificar sintaxis JSON
      run: |
        echo "Verificando sintaxis JSON..."
        python -m json.tool package.json > /dev/null
        echo "‚úÖ Sintaxis JSON verificada"
        
    - name: Verificar archivos de documentaci√≥n
      run: |
        echo "Verificando archivos de documentaci√≥n..."
        for file in *.md; do
          echo "Verificando $file..."
          test -s "$file" || (echo "‚ùå Archivo $file est√° vac√≠o" && exit 1)
        done
        echo "‚úÖ Archivos de documentaci√≥n verificados"
        
    - name: Generar reporte de verificaci√≥n
      run: |
        echo "üìä REPORTE DE VERIFICACI√ìN" > verification_report.txt
        echo "=========================" >> verification_report.txt
        echo "" >> verification_report.txt
        echo "‚úÖ Archivos principales: $(ls -1 *.html *.js *.py *.json *.md | wc -l)" >> verification_report.txt
        echo "‚úÖ M√≥dulos del curso: $(ls -1 modulo*.html | wc -l)" >> verification_report.txt
        echo "‚úÖ Archivos de GitHub: $(ls -1 .github/**/*.md | wc -l)" >> verification_report.txt
        echo "‚úÖ Archivos de configuraci√≥n: $(ls -1 .git* config.* | wc -l)" >> verification_report.txt
        echo "" >> verification_report.txt
        echo "üìÖ Fecha de verificaci√≥n: $(date)" >> verification_report.txt
        echo "üîó Commit: $GITHUB_SHA" >> verification_report.txt
        echo "" >> verification_report.txt
        echo "¬© JMGV-PTEL-2025. TODOS LOS DERECHOS RESERVADOS." >> verification_report.txt
        
    - name: Subir reporte de verificaci√≥n
      uses: actions/upload-artifact@v3
      with:
        name: verification-report
        path: verification_report.txt
        
    - name: Comentar en PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '‚úÖ **Verificaci√≥n completada exitosamente**\n\nTodos los archivos del curso han sido verificados y est√°n listos para producci√≥n.\n\nüìä **Resumen:**\n- ‚úÖ Archivos principales verificados\n- ‚úÖ M√≥dulos del curso verificados\n- ‚úÖ Archivos de GitHub verificados\n- ‚úÖ Configuraci√≥n verificada\n- ‚úÖ Derechos de autor verificados\n- ‚úÖ Sintaxis verificada\n\nüéâ **¬°El curso est√° listo para ser usado!**\n\n¬© JMGV-PTEL-2025. TODOS LOS DERECHOS RESERVADOS.'
          })
